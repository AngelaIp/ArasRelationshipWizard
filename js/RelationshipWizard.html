<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript">
			top.aras.uiAddConfigLink2Doc4Assembly(document, "TreeTable");
		</script>
		<script type="text/javascript">
			//Global variables
			// UI
			
			var inn;
			var THIS;
			
			var gridApplet = null;
			
			var currSelCell = null; //variables to know what cell is being edited
			var currSelRowId = ''; //setted in onGridCellEdit
			var currSelCol = ''; //setted in onGridCellEdit
			
			var itemID;
			
		</script>
		<script>
			function setGridControlDefaults()
			{
				myGridControl = document.MyGrid;
				myGridControl.Delimeter = "|";
				myGridControl.DrawGrid = true;
				myGridControl.noSort = false;
				myGridControl.ColumnDraggable = false;
				myGridControl.Editable = false;
				myGridControl.Justify = true;
				myGridControl.HeaderBGColor = "#d4d0c8";
				myGridControl.setColumnCount(6);
				myGridControl.setInitWidths("20|80|320|80|80|300");
				myGridControl.setHorAligns("LEFT|CENTER|LEFT");
				myGridControl.SetHeaderCol(0, "");
				myGridControl.SetHeaderCol(1, "Item Type");
				myGridControl.SetHeaderCol(2, "Item Name");
				myGridControl.SetHeaderCol(3, "Revision");
				myGridControl.SetHeaderCol(4, "State");
				myGridControl.SetHeaderCol(5, "Result");

				myGridControl.SetColumnProperties('type=noedit', 0);
				myGridControl.SetColumnProperties('type=noedit', 1);
				myGridControl.SetColumnProperties('type=noedit', 2);
				myGridControl.SetColumnProperties('type=noedit', 3);
				myGridControl.SetColumnProperties('type=noedit', 4);
				myGridControl.SetColumnProperties('type=noedit', 5);
				
				 myGridControl.setMultiselect(true);
				
				//myGridControl.addRow("ThisRow1","<img src='../cbin/icons/locked.gif'>" + "|" + "Part" + "|" + "ABC123" + "|" + "01" + "|" + "Prelim" + "|"  + "<checkbox state=0>","ThisRow1");					
				//myGridControl.addRow("ThisRow2","<img src='../cbin/icons/locked_else.gif'>" + "|" + "Part" + "|" + "ABC123" + "|" + "01" + "|" + "Released" + "|" + "OK","ThisRow2");					
			}
			
			function loadDefaults()
			{
				//debugger;
				
				THIS = dialogArguments.item;
				inn = dialogArguments.innovator;
				
				if (dialogArguments.item.getAttribute("type"))
				{
					document.all.Itemtype.value = dialogArguments.item.getAttribute("type");
					document.all.selectItemtype.disabled = true;
					queryRelationshiptypes(document.all.Itemtype.value);
				}
				
				if (dialogArguments.itemKeyedName)
				{
					document.all.Item.value = dialogArguments.itemKeyedName;
					document.all.selectItem.disabled = true;
				}
				if (dialogArguments.itemID)
				{
					itemID = dialogArguments.itemID;
				}
				itemID
				
				
			}
			
			function setItem() 
			{
				//debugger;
				if (!document.all.Itemtype.value)
				{
					return;
				}
				var Item = openItemBrowser(document.all.Itemtype.value);
				if(Item)
				{
					itemID = Item;
					var keyed_name = top.aras.getKeyedNameEx(Item);
					document.all.Item.value = keyed_name;
				}
			}
			
			function setItemtype() 
			{
				
				var Item = openItemBrowser("itemtype");
				//debugger;
				if(Item)
				{
					var keyed_name = top.aras.getKeyedNameEx(Item);
					document.all.Itemtype.value = keyed_name;
					//Clear item instance
					document.all.Item.value = "";
				}
				
				queryRelationshiptypes(Item)
				
			}
			
			function openItemBrowser(findType)
			{
				var param = {
					aras: window.top.aras,
					itemtypeName: findType,
					multiselect: false
				};
				
				var res = showModalDialog(top.aras.getScriptsURL() + 'searchDialog.html', param, 'dialogHeight:450px; dialogWidth:950px; status:0; help:0; resizable:1');
				if (res == undefined) return;
				
				searchedItem = res.item;
				if (!searchedItem)
				{
					return;
				}
				//var keyed_name = top.aras.getKeyedNameEx(searchedItem);
				return searchedItem;
			}
			
			function openItemBrowserChooser(findType) 
			{
				//debugger;
				var param = {
					aras: window.top.aras,
					itemtypeName: findType,
					multiselect: true
				};
				
				var res = showModalDialog(top.aras.getScriptsURL() + 'searchDialog.html', param, 'dialogHeight:450px; dialogWidth:950px; status:0; help:0; resizable:1');
				if (res == undefined) return;
				if (res.length < 1)
				{
					return;
				}
				
				var resCopied = new Array();
				for (var i = 0; i < res.length; i++) resCopied.push(res[i]);
				
				return  "'" + resCopied.join("','") + "'"

			}
			
			function clearGrid() 
			{
				grid = document.MyGrid;
				grid.turnEditOff();
				grid.clear();
			}
			
			function clearPassed()
			{
				debugger;
				//Get all items
				grid = document.MyGrid;
				
				var rowId, rowIds = grid.getAllItemIds(';').split(';');
			    if (rowIds.length == 0) return;
			    for (var i = 0; i < rowIds.length; i++)
			    {
					rowId = rowIds[i];
					
					if (grid.GetCellValue(rowId, 5) == "OK")
					{
						grid.deleteRow(rowId);
					}
				}			
			}
			
			function chooseButton() 
			{
				//Get Value
				var e = document.getElementById("RelationshipList2");
				var strItem = e.options[e.selectedIndex].value;
				
				//Choose Items
				var Items = openItemBrowserChooser(strItem);
				if (!Items) return; 
				
				//Add to Grid
				addItemsToGrid(strItem, Items);
			}
			
			function addItemsToGrid(strItem, Items) 
			{
				//debugger;
				//AML to get items using condition IN
				var qry = inn.newItem();
				var amlQuery = '<AML>' +
					'<Item type=\"' + strItem + '\" action=\"get\" select=\"keyed_name, locked_by_id, state, major_rev\">' +
						'<id condition=\"IN\">' + Items + '</id>' +
					'</Item>' +
				'</AML>';
				
				qry.loadAML(amlQuery)
				var Result = qry.apply();
				if (Result.isError())
				{
					alert(Result.getErrorDetail() + ':  Unable to run query');
					return;
				}
				var Items = Result.getItemsByXPath("//Result/Item");
				
				
				for (var i=0; i < Items.getItemCount(); i++) 
				{
					var Item = Items.getItemByIndex(i);
					var id = Item.getID();
					
					var lockstatus;
					switch (Item.getLockStatus())
					{
						case 0: //not locked
							lockstatus = "<img src=''>";
						break;						
						case 1: //locked by user
							lockstatus = "<img src='../cbin/icons/locked.gif'>";
						break;						
						case 2: //locked by other
							lockstatus = "<img src='../cbin/icons/locked_else.gif'>";
						break;
						default:
							lockstatus = "<img src=''>";
					}
					
					//Add to grid
					myGridControl.addRow(id,lockstatus + "|" + Item.getAttribute("type") + "|" + Item.getProperty("keyed_name") + "|" + Item.getProperty("major_rev")  + "|" + Item.getProperty("state") + "|" + "",id);
				}
			}
			
			function CreateRelations() 
			{
				//debugger;
				grid = document.MyGrid;
				var ids = grid.getAllItemIds("|");
				var id_array = ids.split("|");
				
				if (id_array.length == 0)
				{
					return;
				}
				
				var e = document.getElementById("RelationshipList2");
				var strItem = e.options[e.selectedIndex].text;
				var PermissionWasSet;
				
				if (document.getElementById("ArasPLM").checked)
				{
					//Aras.Server.Security.Identity plmIdentity = Aras.Server.Security.Identity.GetByName("Aras PLM");
					//PermissionWasSet = Aras.Server.Security.Permissions.GrantIdentity(plmIdentity);
				}
				
				
				try
				{
					for (var x = 0 ; x < id_array.length; x++) 
					{
						rowid = id_array[x];
						if (rowid !="") 
						{
							
							//Clear Cell
							grid.setCellValue(rowid, 5, "");
							
							//Check Duplicate
							if (document.getElementById("PreventDuplicate").checked)
							{
								var PreventDuplicateQry = inn.newItem();
								var PreventDuplicateAmlQuery = '<AML>' +
													'<Item type=\"' + strItem + '\" action=\"get\">' +
														'<related_id>' + itemID + '</related_id>' +
														'<source_id>' + rowid  + '</source_id>' +
													'</Item>' +
												'</AML>';
								
								PreventDuplicateQry.loadAML(PreventDuplicateAmlQuery)						
								var PreventDuplicateResult = PreventDuplicateQry.apply();
								if (PreventDuplicateResult.isError())
								{
									grid.setCellValue(rowid, 5, "Error Checking");
									continue;
								}
								
								var string = "//Result/Item[@type='" + strItem + "']";
								var PreventDuplicateItems = PreventDuplicateResult.getItemsByXPath(string);
								if (PreventDuplicateItems.getItemCount() > 0)
								{
									grid.setCellValue(rowid, 5, "Relationship Already Exists");
									continue;
								}								
							}
							
							//Create Relationship
							var qry = inn.newItem();
							var amlQuery = '<AML>' +
												'<Item type=\"' + grid.cells(rowid,1).getValue() + '\" action=\"edit\" id=\"' + rowid + '\">' +
													'<Relationships>' +
														'<Item type=\"' + strItem + '\" action=\"add\">' +
															'<related_id>' + itemID  + '</related_id>' +
														'</Item>' +
													'</Relationships>' +
												'</Item>' +
											'</AML>';
							
							qry.loadAML(amlQuery)						
							var Result = qry.apply();
							if (Result.isError())
							{
								grid.setCellValue(rowid, 5, Result.getErrorDetail());
							}
							else
							{
								grid.setCellValue(rowid, 5, "OK");
							}
						}
					}
				}
				catch (e)
				{
				}
				finally
				{
					if (PermissionWasSet) 
					{	
						//Aras.Server.Security.Permissions.RevokeIdentity(plmIdentity);
					}
				}
			}
			
			function RemoveItemsFromGrid() 
			{
				grid = document.MyGrid;
				var rowId, rowIds = grid.getSelectedItemIds(';').split(';');
			    if (rowIds.length == 0) return;
			    for (var i = 0; i < rowIds.length; i++)
			    {
					rowId = rowIds[i];
					grid.deleteRow(rowId);
				}
			}
			
			function setItemVisability(enabled)
			{
				if (enabled == 1)
				{
					document.all.selectItem.disabled = false;
					return;
				}
				else
				{
					document.all.selectItem.disabled = true;
					return;
				}
			}
			
			function queryRelationshiptypes(relationship) 
			{
				//debugger;
				////get Dropdown Control Element 
				//var div_id = getFieldByName("RelationshipList").id; 
				//var control_id = div_id.substring(0, div_id.indexOf("span")); 
				//var select = document.getElementById(control_id);
				
				var qry = inn.newItem();
				var amlQuery = '<AML>' +
					'<Item type=\"RelationshipType\" action=\"get\" select=\"source_id, related_id, name, label\">' +
						'<source_id>' +
							'<Item type=\"ItemType\" action=\"get\"></Item>' +
						'</source_id>' +
						'<related_id>' +
							'<Item type=\"ItemType\" action=\"get\">' +
								'<name>' + relationship + '</name>' +
							'</Item>' +
						'</related_id>' +
					'</Item>' +
				'</AML>';
				
				qry.loadAML(amlQuery)
				var Result = qry.apply();
				if (Result.isError())
				{
					alert(Result.getErrorDetail() + ':  Unable to run query');
					return;
				}
				var Items = Result.getItemsByXPath("//Result/Item[@type='RelationshipType']");
				//var Items = Result.getItemsByXPath("//Result/source_id");
				
				for (var i=0; i < Items.getItemCount(); i++) 
				{
					var RelationshipTypeItem = Items.getItemByIndex(i);
					var SourceItem = RelationshipTypeItem.getPropertyItem("source_id");
					
					//select.options[i]= new Option(RelationshipTypeItem.getProperty("name"), RelationshipTypeItem.getProperty("id"));
					
					//http://chiragrdarji.wordpress.com/2007/06/06/add-items-in-drop-down-list-or-list-box-using-javascript/
					var opt = document.createElement("option");
        
					// Add an Option object to Drop Down/List Box
					document.getElementById("RelationshipList2").options.add(opt);
					// Assign text and value to Option object
					opt.text = RelationshipTypeItem.getProperty("name");
					opt.value = SourceItem.getItembyIndex(0).getProperty("name");
					
				}			
			}
			
			//function OpenSearchDialog_Assignee(IT_Name)
			//{
			//	var param = {
			//		aras: top.aras,
			//		itemtypeName: IT_Name,
			//		itemContext: item,
			//		itemSelectedID: currSelRowId,
			//		sourceItemTypeName: curITName,
			//		sourcePropertyName: curPropName,
			//		multiselect: false
			//	};
			//	var searchedItem;
			//	var dlgRes = showModalDialog('searchDialog.html', param, 'dialogHeight:450px; dialogWidth:700px; status:0; help:0; resizable:1');
			//	if (dlgRes == undefined) return false;
			//	searchedItem = dlgRes.item;
			//	try
			//	{
			//		if (dlgRes.itemID)
			//		{
			//			var keyedName = dlgRes.keyed_name;
			//			var res = dlgRes.itemID;
			//		}
			//	catch (ex)
			//	{}
			//	if (!searchedItem)
			//	{
			//		top.aras.AlertError(top.aras.getResource("PLM", "impactmatrix.message.item_should_be_selected"));
			//		return;
			//	}
			//	if (!searchedItem)
			//	{
			//		return;
			//	}
			//	var assigneeId = top.aras.getItemProperty(searchedItem, "id", "");
			//	var assigneeName = top.aras.getItemProperty(searchedItem, "keyed_name", "");
			//	//MyGrid.cells(rowId, col).setText(assigneeId);
			//	MyGrid.cells(rowId, 1).setValue(assigneeName);
			//}

		</script>
		<script type="text/javascript" for="MyGrid" event="GridStart(isSuccess)">
			setGridControlDefaults();
		</script>
		<script type="text/javascript" for="MyGrid" event="GridClick(rowId, col)">
			//alert("rowId: " + rowId + ", col:" + col);
			//myGridControl.setSelectedRow(rowId, false, false);
		</script>
		<script type="text/javascript" for="MyGrid" event="GridDoubleClick(rowId)">
		</script>
		<script type="text/javascript" for="MyGrid" event="GridEditCell(mode, rowID, col)">
			mode = 2;
			//var res = OnAffectedEditCell(mode, rowID, col);
			//return res;
			
			var cell = cells(rowID, parseInt(col));
			currSelCell = cell;
			currSelRowId = rowID;
			currSelCol = col;
			cell.SetInputHelperIcon("../images/Icons/16x16/16x16_ellipsis.gif");
			cell.InputHelperEnabled = true;
			
		</script>
		<style>
			#MyGrid {
				display: block;
				position: absolute;
				top: 1px;
				left: 350px;
			}
		</style>

	</head>
    <body onload="loadDefaults();">
	
		<object id="MyGrid" style="width:600px; height:270px;" classid="../cbin/TreeTable.dll#Aras.Client.Controls.GridContainer"></object>
		<br>

		<table border="0" cellpadding="0" cellspacing="3">
			<tr>
				<td>
					Item Type:
				</td>
				<td>
					<input type="text" name="Itemtype" readonly="readonly">
				</td>
				<td>
					<input id="selectItemtype" name="selectItemtype" size="4" type="button" value="Itemtype" onclick="setItemtype()">
				</td>
			</tr>
			<tr>
				<td>
					Item Name:
				</td>
				<td>
					<input type="text" name="Item" readonly="readonly">
				</td>
				<td>
					<input id="selectItem" name="selectItem" size="4" type="button" value="Item" onclick="setItem()">
				</td>
			</tr>
			<tr>
				<td>
					Choose Relationship:
				</td>
				<td>
					<select id="RelationshipList2" name="RelationshipList2">
					 </select>
				</td>
				<td>
					<input id="chooseItems" name="chooseItems" size="4" type="button" value="Choose Items" onclick="chooseButton()">
				</td>
			</tr>
		</table>
		<br>
		<table border="0" cellpadding="0" cellspacing="3">
			<tr>
				<td>
					Create Relationship:
				</td>
				<td>
					<input id="CreateRelationship" name="CreateRelationship" size="4" type="button" value="Create Relationship" onclick="CreateRelations()">
				</td>
			</tr>
		</table>
		<br>
		<table border="0" cellpadding="0" cellspacing="3">
			<tr>
				<td>
					Delete Selected Row:
				</td>
				<td>
					<input id="DeleteSelected" name="DeleteSelected" size="4" type="button" value="Delete Selected Rows" onclick="RemoveItemsFromGrid()">
				</td>
			</tr>
			<tr>
				<td>
					Clear Successfully Added Items:
				</td>
				<td>
					<input id="ClearPassed" name="ClearPassed" size="4" type="button" value="Clear Passed" onclick="clearPassed()">
				</td>
			</tr>
			<tr>
				<td>
					Clear Grid:
				</td>
				<td>
					<input id="ClearGrid" name="ClearGrid" size="4" type="button" value="Clear Grid" onclick="clearGrid()">
				</td>
			</tr>
		</table>
		<br>
		<table border="0" cellpadding="0" cellspacing="3">
			<tr>
				<td>
					Aras PLM:
				</td>
				<td>
					<input type="checkbox" id="ArasPLM" name="ArasPLM">
				</td>
			</tr>
			<!--<tr>
				<td>
					Force Unlock Item:
				</td>
				<td>
					<input type="checkbox" id="ForceLock" name="ForceLock">
				</td>
			</tr>-->
			<tr>
				<td>
					Prevent Duplicate:
				</td>
				<td>
					<input type="checkbox" id="PreventDuplicate" name="PreventDuplicate">
				</td>
			</tr>
		</table>
	</body>
</html>