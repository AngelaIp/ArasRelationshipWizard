<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript">
			top.aras.uiAddConfigLink2Doc4Assembly(document, "TreeTable");
		</script>
		<script type="text/javascript">
			//Global variables			
			var inn;
			var THIS;
			
			var gridApplet = null;
			
			var currSelCell = null; //variables to know what cell is being edited
			var currSelRowId = ''; //setted in onGridCellEdit
			var currSelCol = ''; //setted in onGridCellEdit
			
			var itemID;
			
			//Column Index and Name
			var LockStatus = ["0",""];
			var ItemType = ["1","Item Type"];
			var ItemName = ["2","Item Name"];
			var Revision = ["3","Revision"];
			var Gen = ["4","Gen"];
			var State = ["5","State"];
			var ResultHeader = ["6","Result"];
			var RelationshipType = ["7","RelationshipType"];

		</script>
		<script type="text/javascript">
			function setGridControlDefaults()
			{
				//Setup Grid
				myGridControl = document.MyGrid;
				myGridControl.Delimeter = "|";
				myGridControl.DrawGrid = true;
				myGridControl.noSort = false;
				myGridControl.ColumnDraggable = false;
				myGridControl.Editable = false;
				myGridControl.Justify = true;
				myGridControl.HeaderBGColor = "#d4d0c8";
				myGridControl.setColumnCount(8);
				myGridControl.setInitWidths("30|80|330|60|40|80|300|100");
				myGridControl.setHorAligns("LEFT|CENTER|LEFT");
				
				myGridControl.SetHeaderCol(0, LockStatus[1]);
				myGridControl.SetHeaderCol(1, ItemType[1]);
				myGridControl.SetHeaderCol(2, ItemName[1]);
				myGridControl.SetHeaderCol(3, Revision[1]);
				myGridControl.SetHeaderCol(4, Gen[1]);
				myGridControl.SetHeaderCol(5, State[1]);
				myGridControl.SetHeaderCol(6, ResultHeader[1]);
				myGridControl.SetHeaderCol(7, RelationshipType[1]);

				myGridControl.SetColumnProperties('type=noedit', 0);
				myGridControl.SetColumnProperties('type=noedit', 1);
				myGridControl.SetColumnProperties('type=noedit', 2);
				myGridControl.SetColumnProperties('type=noedit', 3);
				myGridControl.SetColumnProperties('type=noedit', 4);
				myGridControl.SetColumnProperties('type=noedit', 5);
				myGridControl.SetColumnProperties('type=noedit', 6);
				myGridControl.SetColumnProperties('type=noedit', 7);
				
				 myGridControl.setMultiselect(true);
				
				//myGridControl.addRow("ThisRow1","<img src='../cbin/icons/locked.gif'>" + "|" + "Part" + "|" + "ABC123" + "|" + "01" + "|" + "Prelim" + "|"  + "<checkbox state=0>","ThisRow1");					
				//myGridControl.addRow("ThisRow2","<img src='../cbin/icons/locked_else.gif'>" + "|" + "Part" + "|" + "ABC123" + "|" + "01" + "|" + "Released" + "|" + "OK","ThisRow2");					
			}
			
			function loadDefaults()
			{
				//debugger;
				
				//Get information passed from item
				THIS = dialogArguments.item;
				inn = dialogArguments.innovator;
				top.aras = dialogArguments.aras;
				
				if (dialogArguments.item.getAttribute("type"))
				{
					document.all.Itemtype.value = dialogArguments.item.getAttribute("type");
					document.all.selectItemtype.disabled = true;
					queryRelationshiptypes(document.all.Itemtype.value);
				}
				
				if (dialogArguments.itemKeyedName)
				{
					document.all.Item.value = dialogArguments.itemKeyedName;
					document.all.selectItem.disabled = true;
				}
				if (dialogArguments.itemID)
				{
					itemID = dialogArguments.itemID;
				}
				
				//HIde relationship type column
				SetColumnVisible(RelationshipType[0], false, 0);
				
			}
			
			function setItem() 
			{
				//debugger;
				if (!document.all.Itemtype.value)
				{
					return;
				}
				var Item = openItemBrowser(document.all.Itemtype.value);
				if(Item)
				{
					itemID = Item;
					var keyed_name = top.aras.getKeyedNameEx(Item);
					document.all.Item.value = keyed_name;
				}
			}
			
			function setItemtype() 
			{
				
				var Item = openItemBrowser("itemtype");
				//debugger;
				if(Item)
				{
					var keyed_name = top.aras.getKeyedNameEx(Item);
					document.all.Itemtype.value = keyed_name;
					//Clear item instance
					document.all.Item.value = "";
				}
				
				queryRelationshiptypes(Item)
				
			}
			
			function openItemBrowser(findType)
			{
				var param = {
					aras: window.top.aras,
					itemtypeName: findType,
					multiselect: false
				};
				
				var res = showModalDialog(top.aras.getScriptsURL() + 'searchDialog.html', param, 'dialogHeight:450px; dialogWidth:950px; status:0; help:0; resizable:1');
				if (res == undefined) return;
				
				searchedItem = res.item;
				if (!searchedItem)
				{
					return;
				}
				//var keyed_name = top.aras.getKeyedNameEx(searchedItem);
				return searchedItem;
			}
			
			function openItemBrowserChooser(findType) 
			{
				//debugger;
				var param = {
					aras: window.top.aras,
					itemtypeName: findType,
					multiselect: true
				};
				
				var res = showModalDialog(top.aras.getScriptsURL() + 'searchDialog.html', param, 'dialogHeight:450px; dialogWidth:950px; status:0; help:0; resizable:1');
				if (res == undefined) return;
				if (res.length < 1)
				{
					return;
				}
				
				var resCopied = new Array();
				for (var i = 0; i < res.length; i++) resCopied.push(res[i]);
				
				return  "'" + resCopied.join("','") + "'"

			}
			
			function clearGrid() 
			{
				//debugger;
				//Get all items
				grid = document.MyGrid;
				grid.RemoveAllRows();
				
				//var rowId, rowIds = grid.getAllItemIds(';').split(';');
			    //if (rowIds.length == 0) return;
			    //for (var i = 0; i < rowIds.length; i++)
			    //{
				//	rowId = rowIds[i];
				//	grid.deleteRow(rowId);
				//}
			}
			
			function clearPassed()
			{
				//debugger;
				//Get all items
				grid = document.MyGrid;
				
				var rowId, rowIds = grid.getAllItemIds(';').split(';');
			    if (rowIds.length == 0) return;
			    for (var i = 0; i < rowIds.length; i++)
			    {
					rowId = rowIds[i];
					
					if (grid.GetCellValue(rowId, ResultHeader[0]) == "OK")
					{
						grid.deleteRow(rowId);
					}
				}			
			}
			
			function chooseButton() 
			{
				//Get Value
				var e = document.getElementById("RelationshipList2");
				var strItem = e.options[e.selectedIndex].value;
				var strRelationship = e.options[e.selectedIndex].text;
				
				//Choose Items
				var Items = openItemBrowserChooser(strItem);
				if (!Items) return; 
				
				//Add to Grid
				addItemsToGrid(strItem, strRelationship, Items);
			}
			
			function RunQuery(strItem, Items) 
			{
				//debugger;
				//AML to get items using condition IN
				var qry = inn.newItem();
				var amlQuery = '<AML>' +
					'<Item type=\"' + strItem + '\" action=\"get\" select=\"keyed_name, locked_by_id, state, major_rev, generation\">' +
						'<id condition=\"IN\">' + Items + '</id>' +
					'</Item>' +
				'</AML>';
				
				qry.loadAML(amlQuery)
				return qry.apply();
			}
			
			function addItemsToGrid(strItem, strRelationship, Items) 
			{
				var Result = RunQuery(strItem, Items);
				if (Result.isError())
				{
					alert(Result.getErrorDetail() + ':  Unable to run query');
					return;
				}
				var Items = Result.getItemsByXPath("//Result/Item");
				
				
				for (var i=0; i < Items.getItemCount(); i++) 
				{
					var Item = Items.getItemByIndex(i);
					var id = Item.getID();
					
					var lockstatus;
					switch (Item.getLockStatus())
					{
						case 0: //not locked
							lockstatus = "<img src=''>";
						break;						
						case 1: //locked by user
							lockstatus = "<img src='../cbin/icons/locked.gif'>";
						break;						
						case 2: //locked by other
							lockstatus = "<img src='../cbin/icons/locked_else.gif'>";
						break;
						default:
							lockstatus = "<img src=''>";
					}
					
					if (myGridControl.IsItemExists(id))
					{
						//debugger;
						alert("Item already exists in grid");
						continue;
					}
					
					//Add to grid
					myGridControl.addRow(id,lockstatus + "|" + Item.getAttribute("type") + "|" + Item.getProperty("keyed_name") + "|" + Item.getProperty("major_rev")  + "|" + Item.getProperty("generation")  + "|" + Item.getProperty("state") + "|" + "" + "|" + strRelationship,id);
				}
			}
			
			function UpdateResult(rowId, colIndex, value) 
			{
				grid = document.MyGrid;
				grid.setCellValue(rowId, colIndex, value);
			}
			
			function CreateRelations() 
			{
				//debugger;
				grid = document.MyGrid;
				var ids = grid.getAllItemIds("|");
				var id_array = ids.split("|");
				
				if (id_array.length == 0)
				{
					return;
				}

				for (var x = 0 ; x < id_array.length; x++) 
				{
					rowId = id_array[x];
					//Clear Cell
					UpdateResult(rowId, ResultHeader[0], "");
				}				

				for (var x = 0 ; x < id_array.length; x++) 
				{					
					rowId = id_array[x];
					if (rowId !="") 
					{
						try
						{						
							//Check Duplicate
							if (document.getElementById("PreventDuplicate").checked)
							{
								var PreventDuplicateQry = inn.newItem();
								var PreventDuplicateAmlQuery = '<AML>' +
													'<Item type=\"' + grid.cells(rowId,RelationshipType[0]).getValue() + '\" action=\"get\">' +
														'<related_id>' + itemID + '</related_id>' +
														'<source_id>' + rowId  + '</source_id>' +
													'</Item>' +
												'</AML>';
								
								PreventDuplicateQry.loadAML(PreventDuplicateAmlQuery)						
								var PreventDuplicateResult = PreventDuplicateQry.apply();
								if (PreventDuplicateResult.isError())
								{
									UpdateResult(rowId, ResultHeader[0], "Error Checking Existing Relationship");
									continue;
								}
								
								var string = "//Result/Item[@type='" + grid.cells(rowId,RelationshipType[0]).getValue() + "']";
								var PreventDuplicateItems = PreventDuplicateResult.getItemsByXPath(string);
								if (PreventDuplicateItems.getItemCount() > 0)
								{
									UpdateResult(rowId, ResultHeader[0], "Relationship Already Exists");
									continue;
								}								
							}
							
							var version = (document.getElementById("VersionItem").checked) ? "1" : "0";
							
							//Create Relationship
							var qry = inn.newItem();
							var amlQuery = '<AML>' +
												'<Item type=\"' + grid.cells(rowId,ItemType[0]).getValue() + '\" action=\"edit\" id=\"' + rowId + '\" version=\"' + version + '\">' +
													'<Relationships>' +
														'<Item type=\"' + grid.cells(rowId,RelationshipType[0]).getValue() + '\" action=\"add\">' +
															'<related_id>' + itemID  + '</related_id>' +
														'</Item>' +
													'</Relationships>' +
												'</Item>' +
											'</AML>';
							
							//qry.loadAML(amlQuery)						
							//var Result = qry.apply();
							
							//Email admin regarding the problem
							var param = "<query><![CDATA[" + htmlSpecialChars(amlQuery) + "]]></query>";
							param += "<AMLquery><![CDATA[" + amlQuery + "]]></AMLquery>";
							param += "<ArasPLM>" + document.getElementById("ArasPLM").checked + "</ArasPLM>";
							param += "<user_id>" + top.aras.getUserID() + "</user_id>";
							var Result = top.aras.applyMethod("RRW_RunAML",param);
							
							var d = top.aras.createXMLDocument();
							d.loadXML(Result);
							var nd = d.selectSingleNode("./Result");
							
							UpdateResult(rowId, ResultHeader[0], nd.text);

						}
						catch (e)
						{
							//alert("Error: " + e.message);
							UpdateResult(rowId, ResultHeader[0], e.message);
							continue;
						}
						finally
						{
						}
					}
				}
			}
			
			function htmlSpecialChars(unsafe) 
			{
				return unsafe
				.replace(/&/g, "&amp;")
				.replace(/</g, "&lt;")
				.replace(/>/g, "&gt;")
				.replace(/"/g, "&quot;");
			}
			
			function RemoveItemsFromGrid() 
			{
				grid = document.MyGrid;
				var rowId, rowIds = grid.getSelectedItemIds(';').split(';');
			    if (rowIds.length == 0) return;
			    for (var i = 0; i < rowIds.length; i++)
			    {
					rowId = rowIds[i];
					grid.deleteRow(rowId);
				}
			}
			
			function setItemVisability(enabled)
			{
				if (enabled == 1)
				{
					document.all.selectItem.disabled = false;
					return;
				}
				else
				{
					document.all.selectItem.disabled = true;
					return;
				}
			}
			
			function queryRelationshiptypes(relationship) 
			{
				//debugger;
				////get Dropdown Control Element 
				//var div_id = getFieldByName("RelationshipList").id; 
				//var control_id = div_id.substring(0, div_id.indexOf("span")); 
				//var select = document.getElementById(control_id);
				
				var qry = inn.newItem();
				var amlQuery = '<AML>' +
					'<Item type=\"RelationshipType\" action=\"get\" select=\"source_id, related_id, name, label\">' +
						'<source_id>' +
							'<Item type=\"ItemType\" action=\"get\"></Item>' +
						'</source_id>' +
						'<related_id>' +
							'<Item type=\"ItemType\" action=\"get\">' +
								'<name>' + relationship + '</name>' +
							'</Item>' +
						'</related_id>' +
					'</Item>' +
				'</AML>';
				
				qry.loadAML(amlQuery)
				var Result = qry.apply();
				if (Result.isError())
				{
					alert(Result.getErrorDetail() + ':  Unable to run query');
					return;
				}
				var Items = Result.getItemsByXPath("//Result/Item[@type='RelationshipType']");
				//var Items = Result.getItemsByXPath("//Result/source_id");
				
				for (var i=0; i < Items.getItemCount(); i++) 
				{
					var RelationshipTypeItem = Items.getItemByIndex(i);
					var SourceItem = RelationshipTypeItem.getPropertyItem("source_id");
					
					//select.options[i]= new Option(RelationshipTypeItem.getProperty("name"), RelationshipTypeItem.getProperty("id"));
					
					//http://chiragrdarji.wordpress.com/2007/06/06/add-items-in-drop-down-list-or-list-box-using-javascript/
					var opt = document.createElement("option");
        
					// Add an Option object to Drop Down/List Box
					document.getElementById("RelationshipList2").options.add(opt);
					// Assign text and value to Option object
					opt.text = RelationshipTypeItem.getProperty("name");
					opt.value = SourceItem.getItembyIndex(0).getProperty("name");
					
				}			
			}
			
			function SetColumnVisible(col, visible, col_width)
			{
				grid = document.MyGrid;
				grid.SetColumnVisible(col, visible, col_width);
			}
			
			//function OpenSearchDialog_Assignee(IT_Name)
			//{
			//	var param = {
			//		aras: top.aras,
			//		itemtypeName: IT_Name,
			//		itemContext: item,
			//		itemSelectedID: currSelRowId,
			//		sourceItemTypeName: curITName,
			//		sourcePropertyName: curPropName,
			//		multiselect: false
			//	};
			//	var searchedItem;
			//	var dlgRes = showModalDialog('searchDialog.html', param, 'dialogHeight:450px; dialogWidth:700px; status:0; help:0; resizable:1');
			//	if (dlgRes == undefined) return false;
			//	searchedItem = dlgRes.item;
			//	try
			//	{
			//		if (dlgRes.itemID)
			//		{
			//			var keyedName = dlgRes.keyed_name;
			//			var res = dlgRes.itemID;
			//		}
			//	catch (ex)
			//	{}
			//	if (!searchedItem)
			//	{
			//		top.aras.AlertError(top.aras.getResource("PLM", "impactmatrix.message.item_should_be_selected"));
			//		return;
			//	}
			//	if (!searchedItem)
			//	{
			//		return;
			//	}
			//	var assigneeId = top.aras.getItemProperty(searchedItem, "id", "");
			//	var assigneeName = top.aras.getItemProperty(searchedItem, "keyed_name", "");
			//	//MyGrid.cells(rowId, col).setText(assigneeId);
			//	MyGrid.cells(rowId, 1).setValue(assigneeName);
			//}

		</script>
		<script type="text/javascript" for="MyGrid" event="GridStart(isSuccess)">
			setGridControlDefaults();
		</script>
		<script type="text/javascript" for="MyGrid" event="GridClick(rowId, col)">
			//alert("rowId: " + rowId + ", col:" + col);
			//myGridControl.setSelectedRow(rowId, false, false);
		</script>
		<script type="text/javascript" for="MyGrid" event="GridDoubleClick(rowId)">
		</script>
		<script type="text/javascript" for="MyGrid" event="GridEditCell(mode, rowID, col)">
			mode = 2;
			//var res = OnAffectedEditCell(mode, rowID, col);
			//return res;
			
			var cell = cells(rowID, parseInt(col));
			currSelCell = cell;
			currSelRowId = rowID;
			currSelCol = col;
			cell.SetInputHelperIcon("../images/Icons/16x16/16x16_ellipsis.gif");
			cell.InputHelperEnabled = true;
			
		</script>
		<style>
			.textbox
			{
				width: 200px;
			}
			select
			{
				width: 205px;
			}
			.gridButton
			{
				width: 140px;
			}
			.button
			{
				width: 110px;
			}

			.createbutton
			{
				width: 140px;
			}

			table
			{
				border-collapse: collapse;
			}

			fieldset 
			{
				vertical-align:middle;
			}

			fieldset.Select
			{
				width:70%;
				margin-bottom: auto;
				margin-right: 20px;
				float: left;
				min-height: 130px; 
			}
			fieldset.Options
			{
				margin-top: 20px;
				margin-bottom: auto;
				min-height: 130px;
				text-align: right;
			}
			fieldset.Config
			{
				margin: auto;
				min-height: 120px;
				text-align: right;
			}
			fieldset.CreateRelationship
			{
				min-height: 120px;
				text-align: right;
				position: relative;
				border:0;  
			}
			LEGEND
			{
				padding: 5px;
				text-align: left;
			}
		</style>

	</head>
    <body onload="loadDefaults();">
		<div>
			<fieldset class="Select">
				<legend>Item Configuration</legend>
				<div>
					<table>
						<tr>
							<td>
								Item Type
							</td>
							<td>
								<input class="textbox" type="text" name="Itemtype" readonly="readonly">
							</td>
							<td>
								<input class="button" id="selectItemtype" name="selectItemtype" type="button" value="Itemtype" onclick="setItemtype()">
							</td>
						</tr>
						<tr>
							<td>
								Item Name:
							</td>
							<td>
								<input class="textbox" type="text" name="Item" readonly="readonly">
							</td>
							<td>
								<input class="button" id="selectItem" name="selectItem" type="button" value="Item" onclick="setItem()">
							</td>
						</tr>
						<tr>
							<td>
								Choose Relationship:
							</td>
							<td>
								<select id="RelationshipList2" name="RelationshipList2"></select>
							</td>
							<td>
								<input class="button" id="chooseItems" name="chooseItems" type="button" value="Choose Items" onclick="chooseButton()">
							</td>
						</tr>
					</table>
				</div>
			</fieldset>
			<fieldset class="Options">
				<legend>Configuration</legend>
				<div>
					<div>
						Aras PLM:
						<input type="checkbox" id="ArasPLM" name="ArasPLM">
					</div>
					<div>
						Version Item:
						<input type="checkbox" id="VersionItem" name="VersionItem">
					</div>
					<!--<div>
						Force Unlock Item:
						<input type="checkbox" id="ForceLock" name="ForceLock">
					</div>-->
					<div>
						Prevent Duplicate:
						<input type="checkbox" id="PreventDuplicate" name="PreventDuplicate">
					</div>
				</div>
			</fieldset>

			<fieldset class="Config">
				<legend>Grid</legend>
				<div>
					<div>
						<input class="gridButton" id="DeleteSelected" name="DeleteSelected" type="button" value="Delete Selected Rows" onclick="RemoveItemsFromGrid()">
					</div>
					<div>
						<input class="gridButton" id="ClearPassed" name="ClearPassed" type="button" value="Clear Passed" onclick="clearPassed()">
					</div>
					<div>
						<input class="gridButton" id="ClearGrid" name="ClearGrid" type="button" value="Clear Grid" onclick="clearGrid()">
					</div>

					<br>

					<div>
						<input class="gridButton" id="CreateRelationship" name="CreateRelationship" type="button" value="Create Relationship" onclick="CreateRelations()">
					</div>
				</div>
			</fieldset>
			<!--<fieldset class="CreateRelationship">
				<legend>Group 4</legend>
				<div>
					<input class="createbutton" id="CreateRelationship" name="CreateRelationship" type="button" value="Create Relationship" onclick="CreateRelations()">
				</div>
			</fieldset>-->
		</div>
		<br><br>
		<object id="MyGrid" style="width:950px; height:400px;" classid="../cbin/TreeTable.dll#Aras.Client.Controls.GridContainer"></object>
	</body>
</html>